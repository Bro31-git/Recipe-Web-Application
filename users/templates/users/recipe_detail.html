{% extends "users/base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    /* MAIN THEME VARIABLES */
    :root {
        --primary-green: #69d060;
        --primary-orange: #ef8b17;
        --bg-color: #f8f9fa;
        --text-dark: #333;
        --card-radius: 16px;
        /* Pill Colors */
        --pill-green-bg: #e8f5e9; --pill-green-text: #2e7d32;
        --pill-red-bg: #ffebee;   --pill-red-text: #c62828;
        --pill-orange-bg: #fff3e0;--pill-orange-text: #ef6c00;
        --pill-gray-bg: #f5f5f5;  --pill-gray-text: #616161;
        --pill-blue-bg: #e3f2fd;  --pill-blue-text: #1565c0;
    }

    /* Basic Reset & Typography */
    .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
    
    .card {
        background: white; border-radius: var(--card-radius);
        padding: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 25px;
        border: 1px solid #eee;
    }

    /* HERO SECTION */
    .hero { display: flex; gap: 30px; align-items: flex-start; }
    
    .hero-img-box {
        flex-shrink: 0; width: 45%; height: 320px; border-radius: 16px; overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1); background: #eee; position: relative;
    }
    .hero-img-box img { width: 100%; height: 100%; object-fit: cover; }
    
    .hero-content { 
        flex: 1; display: flex; flex-direction: column; justify-content: center; 
    }
    
    .recipe-title { font-size: 34px; font-weight: 800; line-height: 1.2; margin-bottom: 5px; color: #222; }

    .chef-name { font-size: 14px; color: #666; margin-bottom: 12px; font-weight: 500; }
    .chef-name span { color: var(--primary-orange); font-weight: 700; }

    .origin-tag {
        display: inline-flex; align-items: center; gap: 6px;
        font-size: 13px; color: #555; font-weight: 600;
        background: #f0f2f5; padding: 4px 12px; border-radius: 6px;
        width: fit-content; margin-bottom: 15px; border: 1px solid #e1e4e8;
    }

    .recipe-desc { color: #555; line-height: 1.6; margin-bottom: 20px; font-size: 15px; }

    /* Buttons Row */
    .action-buttons { display: flex; gap: 12px; align-items: center; margin-bottom: 25px; flex-wrap: wrap;}
    
    .btn-save {
        display: inline-flex; align-items: center; gap: 8px;
        background-color: white; color: var(--primary-orange);
        border: 2px solid var(--primary-orange);
        padding: 10px 24px; border-radius: 50px;
        cursor: pointer; font-weight: 700; font-size: 14px;
        transition: all 0.2s; text-decoration: none;
    }
    .btn-save:hover { background-color: #fff8f0; }
    .btn-save.active {
        background-color: var(--primary-orange); color: white;
        box-shadow: 0 4px 10px rgba(239, 139, 23, 0.3);
    }

    /* WATCH VIDEO BUTTON (DIRECT LINK STYLE) */
    .btn-watch-video {
        display: inline-flex; align-items: center; gap: 8px;
        background-color: #d32f2f; /* YouTube Red */
        color: white; border: none;
        padding: 12px 24px; border-radius: 50px;
        cursor: pointer; font-weight: 700; font-size: 14px;
        transition: all 0.2s; text-decoration: none;
    }
    .btn-watch-video:hover {
        background-color: #b71c1c; box-shadow: 0 4px 10px rgba(211, 47, 47, 0.3); transform: translateY(-2px);
    }
    
    .btn-update {
        background-color: #374151; color: white; border: none;
        padding: 12px 24px; border-radius: 50px; text-decoration: none;
        font-weight: 600; font-size: 14px; display: inline-flex; align-items: center; gap: 8px;
        transition: background 0.2s;
    }
    .btn-update:hover { background-color: #1f2937; color: white; }

    /* Stats Pills */
    .stats-row { display: flex; flex-wrap: wrap; gap: 10px; }
    .stat-pill {
        padding: 8px 16px; border-radius: 50px; font-size: 12px; font-weight: 700;
        display: flex; align-items: center; gap: 8px;
    }
    .pill-green { background: var(--pill-green-bg); color: var(--pill-green-text); }
    .pill-red   { background: var(--pill-red-bg);   color: var(--pill-red-text); }
    .pill-orange{ background: var(--pill-orange-bg);color: var(--pill-orange-text); }
    .pill-gray  { background: var(--pill-gray-bg);  color: var(--pill-gray-text); }
    .pill-blue  { background: var(--pill-blue-bg);  color: var(--pill-blue-text); }

    /* Content Grid */
    .content-grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 25px; }
    
    h3.section-header {
        font-size: 20px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;
        padding-bottom: 10px; border-bottom: 1px solid #f0f0f0; color: #222;
    }
    h3.section-header i { color: var(--primary-green); }

    /* Ingredients */
    .ingredient-list { list-style: none; padding: 0; }
    .ingredient-item {
        background: #f9fafb; border-radius: 10px; padding: 14px 16px; 
        margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between;
        border: 1px solid #eee; transition: 0.2s;
    }
    .ingredient-item:hover { border-color: #ddd; background: white; }
    .checkbox-circle {
        width: 22px; height: 22px; border: 2px solid #ccc; border-radius: 50%; cursor: pointer; margin-right: 12px;
        position: relative; transition: 0.2s;
    }
    .checkbox-circle.checked { background-color: var(--primary-green); border-color: var(--primary-green); }
    .checkbox-circle.checked::after {
        content: 'âœ”'; color: white; font-size: 12px; position: absolute; 
        top: 50%; left: 50%; transform: translate(-50%, -50%);
    }

    /* Directions */
    .step-list { list-style: none; padding: 0; }
    .step-item { display: flex; gap: 20px; margin-bottom: 25px; }
    .step-number {
        background-color: var(--primary-orange); color: white;
        width: 35px; height: 35px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-weight: bold; flex-shrink: 0; margin-top: 2px;
        box-shadow: 0 4px 6px rgba(239, 139, 23, 0.2);
    }
    .step-text { line-height: 1.7; color: #444; font-size: 15px; }

    /* Reviews */
    .review-wrapper { display: flex; flex-direction: column; gap: 30px; }
    .review-form-box { background: #f0fdf4; border: 1px solid #dcfce7; padding: 25px; border-radius: 16px; }
    .star-input-group { margin-bottom: 15px; }
    .star-input-group i { font-size: 24px; color: #cbd5e0; cursor: pointer; margin-right: 5px; transition: 0.2s; }
    .star-input-group i.active { color: #ffb400; transform: scale(1.1); }
    textarea.review-box { 
        width: 100%; padding: 15px; border: 1px solid #ddd; border-radius: 10px; 
        margin-bottom: 15px; height: 100px; resize: none; font-family: inherit;
    }
    textarea.review-box:focus { outline: 2px solid var(--primary-green); border-color: transparent; }
    .btn-post { background: var(--primary-green); color: white; border: none; padding: 12px 30px; border-radius: 30px; cursor: pointer; font-weight: 600; font-size: 14px; transition: 0.2s; }
    .btn-post:hover { background: #56ab4f; box-shadow: 0 4px 12px rgba(86, 171, 79, 0.3); }

    .review-item { padding: 20px 0; border-bottom: 1px solid #eee; }
    .review-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .review-user-info { display: flex; align-items: center; gap: 10px; }
    .r-username { font-weight: 700; color: #333; font-size: 15px; }
    .r-date { color: #888; font-size: 12px; }
    .review-content { color: #555; font-size: 15px; line-height: 1.5; }
    
    /* Responsive */
    @media (max-width: 900px) {
        .hero { flex-direction: column; }
        .hero-img-box { width: 100%; height: 260px; }
        .content-grid { grid-template-columns: 1fr; }
    }
</style>
{% endblock %}

{% block content %}
    <div class="container">

        <div class="card hero">
            <div class="hero-img-box">
                {% if recipe.image %}
                    <img src="{{ recipe.image.url }}" alt="{{ recipe.title }}">
                {% else %}
                    <img src="https://via.placeholder.com/800x600?text=No+Image+Available" alt="No Image">
                {% endif %}
            </div>

            <div class="hero-content">
                <h1 class="recipe-title">{{ recipe.title }}</h1>
                
                <div class="chef-name">
                    Recipe by <span>{{ recipe.chef.username }}</span>
                </div>

                {% if recipe.origin_country %}
                <div class="origin-tag">
                    <i class="fas fa-globe-africa"></i> 
                    <span>{{ recipe.origin_country }}</span>
                </div>
                {% endif %}

                <p class="recipe-desc">{{ recipe.description }}</p>

                <div class="action-buttons">
                    {% if user != recipe.chef %}
                        {% if user.is_authenticated %}
                        <button onclick="toggleRecipeSave(event, '{{ recipe.pk }}')" 
                            id="saveRecipeBtn" 
                            class="btn-save {% if recipe in user.saved_recipes.all %}active{% endif %}">
                            <i class="{% if recipe in user.saved_recipes.all %}fas{% else %}far{% endif %} fa-heart" id="saveIcon"></i>
                            <span id="saveText">{% if recipe in user.saved_recipes.all %}Saved{% else %}Save Recipe{% endif %}</span>
                        </button>
                        {% else %}
                            <a href="{% url 'login' %}" class="btn-save">
                                <i class="far fa-heart"></i>
                                <span>Save Recipe</span>
                            </a>
                        {% endif %}
                    {% endif %}

                    {% if recipe.video_url %}
                    <a href="{{ recipe.video_url }}" target="_blank" class="btn-watch-video">
                        <i class="fas fa-play"></i> Watch on YouTube
                    </a>
                    {% endif %}

                    {% if user == recipe.chef %}
                    <a href="{% url 'recipe-update' recipe.pk %}" class="btn-update">
                        <i class="fas fa-edit"></i> Edit Recipe
                    </a>
                    {% endif %}
                </div>
                <div class="stats-row">
                    {% if recipe.budget %}
                    <div class="stat-pill pill-green"><i class="fas fa-tag"></i> <span>{{ recipe.budget }} {% if recipe.currency %}{{ recipe.currency }}{% else %}FCFA{% endif %}</span></div>
                    {% endif %}
                    {% if recipe.meal_time %}
                    <div class="stat-pill pill-green"><i class="fas fa-clock"></i> <span>{{ recipe.meal_time }}</span></div>
                    {% endif %}
                    {% if recipe.health_condition %}
                    <div class="stat-pill pill-red"><i class="fas fa-heartbeat"></i> <span>{{ recipe.health_condition }}</span></div>
                    {% endif %}
                    {% if recipe.dietary %}
                    <div class="stat-pill pill-orange"><i class="fas fa-leaf"></i> <span>{{ recipe.dietary }}</span></div>
                    {% endif %}
                    {% if recipe.meal_type %}
                    <div class="stat-pill pill-gray"><i class="fas fa-utensils"></i> <span>{{ recipe.meal_type }}</span></div>
                    {% endif %}
                    {% if recipe.cooking_time %}
                    <div class="stat-pill pill-blue"><i class="fas fa-clock"></i> <span>{{ recipe.cooking_time }} min</span></div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="content-grid">
            <div class="card">
                <h3 class="section-header"><i class="fas fa-carrot"></i> Ingredients</h3>
                <p style="color:#666; font-size:13px; margin-bottom:15px;">Tap to check off items</p>
                <ul class="ingredient-list">
                    {% for item in ingredients_list %}
                        <li class="ingredient-item">
                            <div style="display:flex; align-items:center;">
                                <div class="checkbox-circle" onclick="this.classList.toggle('checked')"></div>
                                <span style="font-size:15px;">{{ item.name|title }}</span>
                            </div>
                            {% if item.qty %}
                                <span style="font-weight:bold; color:#ef8b17; font-size:13px;">{{ item.qty }}</span>
                            {% endif %}
                        </li>
                    {% empty %}
                        <p style="color:#888;">No ingredients listed.</p>
                    {% endfor %}
                </ul>
            </div>

            <div class="card">
                <h3 class="section-header"><i class="fas fa-fire-alt"></i> Directions</h3>
                <ul class="step-list">
                    {% for step in instructions_list %}
                        <li class="step-item">
                            <div class="step-number">{{ forloop.counter }}</div>
                            <div class="step-text">{{ step }}</div>
                        </li>
                    {% empty %}
                        <p style="color:#888;">No directions listed.</p>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <div class="card" style="margin-top: 25px;">
            <h3 class="section-header"><i class="fas fa-comment-alt"></i> Reviews</h3>
            <div class="review-wrapper">
                
                {% if user.is_authenticated %}
                <div class="review-form-box">
                    <div style="font-size:13px; color:#2e7d32; font-weight:700; margin-bottom:10px;">
                        <i class="fas fa-user-circle"></i> Posting as {{ user.username }}
                    </div>
                    <form method="POST">
                        {% csrf_token %}
                        <input type="number" name="rating" id="ratingValue" style="display:none;" required>

                        <div class="star-input-group" id="starInput">
                            <i class="fas fa-star" data-val="1"></i>
                            <i class="fas fa-star" data-val="2"></i>
                            <i class="fas fa-star" data-val="3"></i>
                            <i class="fas fa-star" data-val="4"></i>
                            <i class="fas fa-star" data-val="5"></i>
                        </div>
                        <textarea name="content" class="review-box" placeholder="How was it? Share your experience..." required></textarea>
                        <button type="submit" class="btn-post">Post Review</button>
                    </form>
                </div>
                {% else %}
                <div style="text-align:center; padding: 30px; background:#f9f9f9; border-radius:12px;">
                    <p style="color:#555;">Please <a href="{% url 'login' %}" style="color:var(--primary-green); font-weight:bold;">login</a> to leave a review.</p>
                </div>
                {% endif %}

                <div class="review-feed">
                    {% for review in recipe.reviews.all reversed %}
                        <div class="review-item">
                            <div class="review-header">
                                <div class="review-user-info">
                                    <span class="r-username">{{ review.user.username }}</span>
                                    <span class="r-date">- {{ review.created_at|date:"M d, Y" }}</span>
                                </div>
                                <div>
                                    {% with ''|center:5 as range %}
                                    {% for _ in range %}
                                        {% if forloop.counter <= review.rating %}
                                            <i class="fas fa-star" style="color:#ffb400; font-size:13px;"></i>
                                        {% else %}
                                            <i class="far fa-star" style="color:#ddd; font-size:13px;"></i>
                                        {% endif %}
                                    {% endfor %}
                                    {% endwith %}
                                </div>
                            </div>
                            <div class="review-content">{{ review.content }}</div>
                        </div>
                    {% empty %}
                        <p style="color:#999; margin-top:20px; font-style:italic;">No reviews yet. Be the first!</p>
                    {% endfor %}
                </div>

            </div>
        </div>

    </div>
{% endblock %}

{% block extra_js %}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        const stars = document.querySelectorAll('.star-input-group i');
        const ratingInput = document.getElementById('ratingValue');

        if (stars.length > 0 && ratingInput) {
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    const value = this.getAttribute('data-val');
                    ratingInput.value = value;
                    stars.forEach(s => {
                        if (s.getAttribute('data-val') <= value) {
                            s.classList.add('active'); 
                            s.classList.remove('far'); 
                            s.classList.add('fas');    
                        } else {
                            s.classList.remove('active');
                            s.classList.add('far');       
                            s.classList.remove('fas');
                        }
                    });
                });
            });
        }
        
        
    });
</script>
{% endblock %}
