{% extends 'users/base.html' %}
{% load static %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&family=Lobster&display=swap" rel="stylesheet">

<style>
    /* ROOT THEME VARIABLES */
    :root {
      --card: #e9e9e9; 
      --card-actual: rgba(248, 237, 230, 0.911); 
      --accent: #ef8b17;
      --btn-login: rgba(239, 139, 23, 0.9);
      --orange: rgba(239, 139, 23, 0.94);
      --text: #333;
      --muted: #625e5e;
      --light: #ffffff;
    }

    /* PAGE LAYOUT */
    /* Main page wrapper - centered flex container with full viewport height */
    .recipe-page-wrapper {
        font-family: Poppins, -apple-system, Segoe UI, Roboto, sans-serif;
        position: relative;
        display: flex;
        justify-content: center;
        padding: 24px 12px;
        min-height: 100vh;
    }

    .parallax-bg {
      position: fixed;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      background: transparent; 
      z-index: -1;
    }

    .form-container {
      width: 100%;
      max-width: 720px;
      background: transparent;
    }

    .form-card {
      background: var(--card-actual);
      border-radius: 14px;
      padding: 18px 28px;
      margin-bottom: 18px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }

    h2 {
      margin: 0 0 12px;
      color: var(--text);
      font-size: 20px;
      font-weight: 600;
    }

    label {
      display: block;
      margin-bottom: 6px;
      color: var(--text);
      font-weight: 600;
      font-size: 14px;
    }

    .hint {
      font-size: 10px;
      color: var(--light);
      margin-top: 4px;
    }

    /* INPUT FIELD STYLES */
    /* Unified styling for all form input types */
    input[type="text"], 
    input[type="number"], 
    textarea, 
    select,
    input[type="url"] {
      width: 100%;
      padding: 10px 14px;
      border-radius: 3px;
      border: 2px solid var(--light);
      background: #f5f5f5;
      outline: none;
      cursor: pointer;
      font-family: "Inter", sans-serif; 
      font-size: 14px;
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      transition: ease 0.5s; 
      box-sizing: border-box; 
    }

    input:hover, textarea:hover, select:hover,
    input:focus, textarea:focus, select:focus {
      background: var(--light);
      border-color: var(--orange);
      box-shadow: 0 0 0 5px rgba(246, 160, 121, 0.2);
    }

    input[type="file"] {
      display: none;
    }

    /* DESCRIPTION & IMAGE UPLOAD SECTION */
    /* Two-column layout: description textarea + image upload box */
    .desc-row { 
      display: flex; 
      gap: 12px; 
      align-items: stretch; 
    }
    
    .desc-row textarea { 
      flex: 3; 
      min-height: 140px !important;  
      max-height: 140px !important; 
      resize: none !important; 
    }

    .upload-area { 
      flex: 1; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      gap: 8px;
      border: 2px solid #c9c9c9;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      background: linear-gradient(to bottom, rgba(250, 248, 248, 0.7), rgba(0,0,0,0.6)), #555; 
      background-size: cover;
      transition: ease 0.3s;
      justify-content: center;
      height: 140px; 
      box-sizing: border-box;
    }
    
    .upload-area:hover {
      box-shadow: 0 0 0 5px rgba(246, 160, 121, 0.2);
    }

    .upload-label-text {
      font-size: 14px;
      color: #fff;
      font-weight: 500;
    }

    .file-icon-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #f4aacde3;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4'%3E%3C/path%3E%3Cpolyline points='16 17 21 12 16 7'%3E%3C/polyline%3E%3Cline x1='21' y1='12' x2='9' y2='12'%3E%3C/line%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: center;
      background-size: 18px;
      transform: rotate(-90deg);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: 1px solid rgba(0,0,0,0.05);
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
    }

    /* DYNAMIC ROWS (Ingredients & Steps) */
    /* Wrapper for dynamically added rows */
    .dynamic-row-wrapper {
        margin-bottom: 10px;
    }

    /* Flexbox layout for ingredient and step input rows */
    .ingredient-row, .step-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }

    .ingredient-row input:first-child { flex: 2; }
    .ingredient-row input.qty { flex: 1; }
    .step-row input { flex: 1; }

    /* ACTION BUTTONS (Add/Remove Rows)*/
    /* Circular button for adding/removing ingredients and steps */
    .action-btn {
      border: solid 2px var(--btn-login);
      background: var(--light);
      color: var(--btn-login);
      border-radius: 50%;
      width: 36px;
      height: 36px;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: ease 0.5s;
      flex-shrink: 0;
      padding: 0;
      line-height: 1;
    }

    .action-btn:hover {
      background: linear-gradient(180deg,var(--btn-login), #c9655a);
      border-color: var(--orange);
      box-shadow: 0 0 0 5px rgba(246, 160, 121, 0.2);
      color: #fff;
    }

    /* LAYOUT UTILITIES */
    /* Two-column grid layout for side-by-side fields */
    .grid-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .margin-top-12 {
      margin-top: 12px;
      font-weight: 500;
      font-size: 15px;
    }

    /* WORD COUNTER */
    /* Live word counter display for description field */
    .word-counter {
        float: right;
        font-size: 12px;
        color: var(--muted);
        font-weight: 400;
        transition: color 0.3s;
    }
    .word-counter.limit-reached {
        color: #d32f2f;
    }

    /* BUDGET AMOUNT SECTION */
    /* Flex container for budget amount and currency selector */
    .amount-container {
      display: flex;
      gap: 12px;
      align-items: stretch;
      margin-top: 6px;  
    }
    
    .amount-input { flex: 3; }
    .currency-select-wrapper { flex: 1; min-width: 100px; }
    
    .amount-info {
      font-size: 11px;
      color: var(--muted);
      margin-top: 8px;
      min-height: 16px;
    }

    /* SUBMIT BUTTON */
    /* Full-width form submission button */
    .submit-btn {
      width: 100%;
      padding: 14px;
      border-radius: 14px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      background: linear-gradient(180deg,var(--btn-login), #c9655a);
      color: #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
      cursor: pointer;
      transition: background 0.5s ease, transform 160ms ease, box-shadow 240ms ease;
    }
    .submit-btn:hover {
        transform: translateY(-2px);
    }

    /* CUSTOM SELECT DROPDOWN */
    .custom-select {
      position: relative;
      width: 100%;
    }
    .custom-select-trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 9px 12px;
      border-radius: 6px;
      background: #f5f5f5;
      border: 2px solid var(--light);
      cursor: pointer;
      font-size: 14px;
      min-height: 44px;
      transition: ease 0.3s;
      box-sizing: border-box;
    }
    .custom-select-trigger:hover {
      border-color: var(--orange);
      box-shadow: 0 0 0 5px rgba(246, 160, 121, 0.2);
      background: var(--light);
    }
    .custom-options {
      position: absolute;
      left: 0;
      right: 0;
      top: calc(100% + 4px);
      border-radius: 8px;
      background: #fff;
      box-shadow: 0 8px 30px rgba(0,0,0,0.18);
      max-height: 0;
      opacity: 0;
      overflow-y: auto;
      transition: all .28s ease;
      z-index: 100;
    }
    .custom-select.open .custom-options {
      max-height: 220px;
      opacity: 1;
    }
    .custom-option {
      padding: 10px 12px;
      cursor: pointer;
      font-size: 14px;
      border-bottom: 1px solid #f1f1f1;
      color: #333;
    }
    .custom-option:hover {
      background: rgba(246,160,121,0.1);
    }
    .custom-hidden {
      display: none !important;
    }

    @media (max-width: 720px) {
      .form-container {
        max-width: none;
      } 
      .recipe-page-wrapper {
        padding: 25px 5px;
      } 
      .desc-row { 
        flex-direction: column; 
    }
      .grid-row { 
        grid-template-columns: 1fr; 
    }
      .ingredient-row { 
        display: grid; grid-template-columns: 1fr 0.3fr auto; 
    }
      .form-card { 
        padding: 14px; 
    }
    }

    /* VIDEO URL INPUT WITH ICON */
    .video-input-wrapper {
        position: relative;
        width: 100%;
    }

    /* The SVG Icon */
    .yt-svg-icon {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        width: 24px;
        height: 24px;
        fill: #d32f2f; /* YouTube Red */
        pointer-events: none; /* Let clicks pass to input */
        z-index: 10;
    }

    /* The Input Field */
    .video-input {
        width: 100%;
        /* Extra padding on left (45px) so text starts after the icon */
        padding: 10px 14px 10px 45px !important; 
        border-radius: 3px;
        border: 2px solid var(--light);
        background: #f5f5f5;
        outline: none;
        transition: ease 0.5s;
        box-sizing: border-box;
    }

    .video-input:focus {
        background: var(--light);
        border-color: var(--orange);
        box-shadow: 0 0 0 5px rgba(246, 160, 121, 0.2);
    }

  input[type="file"]:invalid + .hint {
    color: red;
    font-weight: bold;
}
</style>
{% endblock %}

{% block content %}
<!-- Main page container -->
<div class="recipe-page-wrapper">
    <!-- Background decoration element -->
    <div class="parallax-bg" aria-hidden="true"></div>

    <!-- Recipe submission form - multipart for file uploads -->
    <form class="form-container" id="recipeForm" method="post" enctype="multipart/form-data">
        <!-- Security token for form submission -->
        {% csrf_token %}
        <!-- Hidden fields to store JSON arrays of ingredients and instructions -->
        <input type="hidden" name="ingredients" id="id_ingredients" value="{{ form.ingredients.value|default:'[]'|force_escape }}">
        <input type="hidden" name="instructions" id="id_instructions" value="{{ form.instructions.value|default:'[]' |force_escape}}">

        {% if form.errors %}
            <div class="form-card" style="border: 1px solid red;">
                <p style="color: red; font-size: 14px;">Please correct the errors below:</p>
                {{ form.errors }}
            </div>
        {% endif %}

        <!-- BASIC RECIPE INFO CARD -->
        <div class="form-card">
            <!-- Recipe Title Input -->
            <label for="recipeName">Recipe Name</label>
            <input type="text" name="title" id="recipeName" placeholder="Tomato, pepper, onion" value="{{ form.title.value|default:'' }}" required>

            <!-- Recipe Origin Country Dropdown -->
            <label class="margin-top-12" for="country">Recipe Origins</label>
            <select name="origin_country" id="country">
                <option value="">Select country</option>
                <option value="AF" {% if form.origin_country.value == 'AF' %}selected{% endif %}>Afghanistan</option>
                    <option value="AL" {% if form.origin_country.value == 'AL' %}selected{% endif %}>Albania</option>
                    <option value="DZ" {% if form.origin_country.value == 'DZ' %}selected{% endif %}>Algeria</option>
                    <option value="AS" {% if form.origin_country.value == 'AS' %}selected{% endif %}>American Samoa</option>
                    <option value="AD" {% if form.origin_country.value == 'AD' %}selected{% endif %}>Andorra</option>
                    <option value="AO" {% if form.origin_country.value == 'AO' %}selected{% endif %}>Angola</option>
                    <option value="AI" {% if form.origin_country.value == 'AI' %}selected{% endif %}>Anguilla</option>
                    <option value="AQ" {% if form.origin_country.value == 'AQ' %}selected{% endif %}>Antarctica</option>
                    <option value="AG" {% if form.origin_country.value == 'AG' %}selected{% endif %}>Antigua and Barbuda</option>
                    <option value="AR" {% if form.origin_country.value == 'AR' %}selected{% endif %}>Argentina</option>
                    <option value="AM" {% if form.origin_country.value == 'AM' %}selected{% endif %}>Armenia</option>
                    <option value="AW" {% if form.origin_country.value == 'AW' %}selected{% endif %}>Aruba</option>
                    <option value="AU" {% if form.origin_country.value == 'AU' %}selected{% endif %}>Australia</option>
                    <option value="AT" {% if form.origin_country.value == 'AT' %}selected{% endif %}>Austria</option>
                    <option value="AZ" {% if form.origin_country.value == 'AZ' %}selected{% endif %}>Azerbaijan</option>
                    <option value="BS" {% if form.origin_country.value == 'BS' %}selected{% endif %}>Bahamas</option>
                    <option value="BH" {% if form.origin_country.value == 'BH' %}selected{% endif %}>Bahrain</option>
                    <option value="BD" {% if form.origin_country.value == 'BD' %}selected{% endif %}>Bangladesh</option>
                    <option value="BB" {% if form.origin_country.value == 'BB' %}selected{% endif %}>Barbados</option>
                    <option value="BY" {% if form.origin_country.value == 'BY' %}selected{% endif %}>Belarus</option>
                    <option value="BE" {% if form.origin_country.value == 'BE' %}selected{% endif %}>Belgium</option>
                    <option value="BZ" {% if form.origin_country.value == 'BZ' %}selected{% endif %}>Belize</option>
                    <option value="BJ" {% if form.origin_country.value == 'BJ' %}selected{% endif %}>Benin</option>
                    <option value="BM" {% if form.origin_country.value == 'BM' %}selected{% endif %}>Bermuda</option>
                    <option value="BT" {% if form.origin_country.value == 'BT' %}selected{% endif %}>Bhutan</option>
                    <option value="BO" {% if form.origin_country.value == 'BO' %}selected{% endif %}>Bolivia</option>
                    <option value="BA" {% if form.origin_country.value == 'BA' %}selected{% endif %}>Bosnia and Herzegovina</option>
                    <option value="BW" {% if form.origin_country.value == 'BW' %}selected{% endif %}>Botswana</option>
                    <option value="BR" {% if form.origin_country.value == 'BR' %}selected{% endif %}>Brazil</option>
                    <option value="BN" {% if form.origin_country.value == 'BN' %}selected{% endif %}>Brunei Darussalam</option>
                    <option value="BG" {% if form.origin_country.value == 'BG' %}selected{% endif %}>Bulgaria</option>
                    <option value="BF" {% if form.origin_country.value == 'BF' %}selected{% endif %}>Burkina Faso</option>
                    <option value="BI" {% if form.origin_country.value == 'BI' %}selected{% endif %}>Burundi</option>
                    <option value="CV" {% if form.origin_country.value == 'CV' %}selected{% endif %}>Cabo Verde</option>
                    <option value="KH" {% if form.origin_country.value == 'KH' %}selected{% endif %}>Cambodia</option>
                    <option value="CM" {% if form.origin_country.value == 'CM' %}selected{% endif %}>Cameroon</option>
                    <option value="CA" {% if form.origin_country.value == 'CA' %}selected{% endif %}>Canada</option>
                    <option value="KY" {% if form.origin_country.value == 'KY' %}selected{% endif %}>Cayman Islands</option>
                    <option value="CF" {% if form.origin_country.value == 'CF' %}selected{% endif %}>Central African Republic</option>
                    <option value="TD" {% if form.origin_country.value == 'TD' %}selected{% endif %}>Chad</option>
                    <option value="CL" {% if form.origin_country.value == 'CL' %}selected{% endif %}>Chile</option>
                    <option value="CN" {% if form.origin_country.value == 'CN' %}selected{% endif %}>China</option>
                    <option value="CO" {% if form.origin_country.value == 'CO' %}selected{% endif %}>Colombia</option>
                    <option value="KM" {% if form.origin_country.value == 'KM' %}selected{% endif %}>Comoros</option>
                    <option value="CG" {% if form.origin_country.value == 'CG' %}selected{% endif %}>Congo</option>
                    <option value="CD" {% if form.origin_country.value == 'CD' %}selected{% endif %}>Congo, Democratic Republic of the</option>
                    <option value="CK" {% if form.origin_country.value == 'CK' %}selected{% endif %}>Cook Islands</option>
                    <option value="CR" {% if form.origin_country.value == 'CR' %}selected{% endif %}>Costa Rica</option>
                    <option value="CI" {% if form.origin_country.value == 'CI' %}selected{% endif %}>Côte d'Ivoire</option>
                    <option value="HR" {% if form.origin_country.value == 'HR' %}selected{% endif %}>Croatia</option>
                    <option value="CU" {% if form.origin_country.value == 'CU' %}selected{% endif %}>Cuba</option>
                    <option value="CY" {% if form.origin_country.value == 'CY' %}selected{% endif %}>Cyprus</option>
                    <option value="CZ" {% if form.origin_country.value == 'CZ' %}selected{% endif %}>Czechia</option>
                    <option value="DK" {% if form.origin_country.value == 'DK' %}selected{% endif %}>Denmark</option>
                    <option value="DJ" {% if form.origin_country.value == 'DJ' %}selected{% endif %}>Djibouti</option>
                    <option value="DM" {% if form.origin_country.value == 'DM' %}selected{% endif %}>Dominica</option>
                    <option value="DO" {% if form.origin_country.value == 'DO' %}selected{% endif %}>Dominican Republic</option>
                    <option value="EC" {% if form.origin_country.value == 'EC' %}selected{% endif %}>Ecuador</option>
                    <option value="EG" {% if form.origin_country.value == 'EG' %}selected{% endif %}>Egypt</option>
                    <option value="SV" {% if form.origin_country.value == 'SV' %}selected{% endif %}>El Salvador</option>
                    <option value="GQ" {% if form.origin_country.value == 'GQ' %}selected{% endif %}>Equatorial Guinea</option>
                    <option value="ER" {% if form.origin_country.value == 'ER' %}selected{% endif %}>Eritrea</option>
                    <option value="EE" {% if form.origin_country.value == 'EE' %}selected{% endif %}>Estonia</option>
                    <option value="SZ" {% if form.origin_country.value == 'SZ' %}selected{% endif %}>Eswatini</option>
                    <option value="ET" {% if form.origin_country.value == 'ET' %}selected{% endif %}>Ethiopia</option>
                    <option value="FJ" {% if form.origin_country.value == 'FJ' %}selected{% endif %}>Fiji</option>
                    <option value="FI" {% if form.origin_country.value == 'FI' %}selected{% endif %}>Finland</option>
                    <option value="FR" {% if form.origin_country.value == 'FR' %}selected{% endif %}>France</option>
                    <option value="GA" {% if form.origin_country.value == 'GA' %}selected{% endif %}>Gabon</option>
                    <option value="GM" {% if form.origin_country.value == 'GM' %}selected{% endif %}>Gambia</option>
                    <option value="GE" {% if form.origin_country.value == 'GE' %}selected{% endif %}>Georgia</option>
                    <option value="DE" {% if form.origin_country.value == 'DE' %}selected{% endif %}>Germany</option>
                    <option value="GH" {% if form.origin_country.value == 'GH' %}selected{% endif %}>Ghana</option>
                    <option value="GR" {% if form.origin_country.value == 'GR' %}selected{% endif %}>Greece</option>
                    <option value="GD" {% if form.origin_country.value == 'GD' %}selected{% endif %}>Grenada</option>
                    <option value="GU" {% if form.origin_country.value == 'GU' %}selected{% endif %}>Guam</option>
                    <option value="GT" {% if form.origin_country.value == 'GT' %}selected{% endif %}>Guatemala</option>
                    <option value="GN" {% if form.origin_country.value == 'GN' %}selected{% endif %}>Guinea</option>
                    <option value="GW" {% if form.origin_country.value == 'GW' %}selected{% endif %}>Guinea-Bissau</option>
                    <option value="GY" {% if form.origin_country.value == 'GY' %}selected{% endif %}>Guyana</option>
                    <option value="HT" {% if form.origin_country.value == 'HT' %}selected{% endif %}>Haiti</option>
                    <option value="HN" {% if form.origin_country.value == 'HN' %}selected{% endif %}>Honduras</option>
                    <option value="HK" {% if form.origin_country.value == 'HK' %}selected{% endif %}>Hong Kong</option>
                    <option value="HU" {% if form.origin_country.value == 'HU' %}selected{% endif %}>Hungary</option>
                    <option value="IS" {% if form.origin_country.value == 'IS' %}selected{% endif %}>Iceland</option>
                    <option value="IN" {% if form.origin_country.value == 'IN' %}selected{% endif %}>India</option>
                    <option value="ID" {% if form.origin_country.value == 'ID' %}selected{% endif %}>Indonesia</option>
                    <option value="IR" {% if form.origin_country.value == 'IR' %}selected{% endif %}>Iran</option>
                    <option value="IQ" {% if form.origin_country.value == 'IQ' %}selected{% endif %}>Iraq</option>
                    <option value="IE" {% if form.origin_country.value == 'IE' %}selected{% endif %}>Ireland</option>
                    <option value="IL" {% if form.origin_country.value == 'IL' %}selected{% endif %}>Israel</option>
                    <option value="IT" {% if form.origin_country.value == 'IT' %}selected{% endif %}>Italy</option>
                    <option value="JM" {% if form.origin_country.value == 'JM' %}selected{% endif %}>Jamaica</option>
                    <option value="JP" {% if form.origin_country.value == 'JP' %}selected{% endif %}>Japan</option>
                    <option value="JO" {% if form.origin_country.value == 'JO' %}selected{% endif %}>Jordan</option>
                    <option value="KZ" {% if form.origin_country.value == 'KZ' %}selected{% endif %}>Kazakhstan</option>
                    <option value="KE" {% if form.origin_country.value == 'KE' %}selected{% endif %}>Kenya</option>
                    <option value="KI" {% if form.origin_country.value == 'KI' %}selected{% endif %}>Kiribati</option>
                    <option value="KP" {% if form.origin_country.value == 'KP' %}selected{% endif %}>Korea, North</option>
                    <option value="KR" {% if form.origin_country.value == 'KR' %}selected{% endif %}>Korea, South</option>
                    <option value="KW" {% if form.origin_country.value == 'KW' %}selected{% endif %}>Kuwait</option>
                    <option value="KG" {% if form.origin_country.value == 'KG' %}selected{% endif %}>Kyrgyzstan</option>
                    <option value="LA" {% if form.origin_country.value == 'LA' %}selected{% endif %}>Laos</option>
                    <option value="LV" {% if form.origin_country.value == 'LV' %}selected{% endif %}>Latvia</option>
                    <option value="LB" {% if form.origin_country.value == 'LB' %}selected{% endif %}>Lebanon</option>
                    <option value="LS" {% if form.origin_country.value == 'LS' %}selected{% endif %}>Lesotho</option>
                    <option value="LR" {% if form.origin_country.value == 'LR' %}selected{% endif %}>Liberia</option>
                    <option value="LY" {% if form.origin_country.value == 'LY' %}selected{% endif %}>Libya</option>
                    <option value="LI" {% if form.origin_country.value == 'LI' %}selected{% endif %}>Liechtenstein</option>
                    <option value="LT" {% if form.origin_country.value == 'LT' %}selected{% endif %}>Lithuania</option>
                    <option value="LU" {% if form.origin_country.value == 'LU' %}selected{% endif %}>Luxembourg</option>
                    <option value="MO" {% if form.origin_country.value == 'MO' %}selected{% endif %}>Macao</option>
                    <option value="MG" {% if form.origin_country.value == 'MG' %}selected{% endif %}>Madagascar</option>
                    <option value="MW" {% if form.origin_country.value == 'MW' %}selected{% endif %}>Malawi</option>
                    <option value="MY" {% if form.origin_country.value == 'MY' %}selected{% endif %}>Malaysia</option>
                    <option value="MV" {% if form.origin_country.value == 'MV' %}selected{% endif %}>Maldives</option>
                    <option value="ML" {% if form.origin_country.value == 'ML' %}selected{% endif %}>Mali</option>
                    <option value="MT" {% if form.origin_country.value == 'MT' %}selected{% endif %}>Malta</option>
                    <option value="MH" {% if form.origin_country.value == 'MH' %}selected{% endif %}>Marshall Islands</option>
                    <option value="MR" {% if form.origin_country.value == 'MR' %}selected{% endif %}>Mauritania</option>
                    <option value="MU" {% if form.origin_country.value == 'MU' %}selected{% endif %}>Mauritius</option>
                    <option value="MX" {% if form.origin_country.value == 'MX' %}selected{% endif %}>Mexico</option>
                    <option value="FM" {% if form.origin_country.value == 'FM' %}selected{% endif %}>Micronesia</option>
                    <option value="MD" {% if form.origin_country.value == 'MD' %}selected{% endif %}>Moldova</option>
                    <option value="MC" {% if form.origin_country.value == 'MC' %}selected{% endif %}>Monaco</option>
                    <option value="MN" {% if form.origin_country.value == 'MN' %}selected{% endif %}>Mongolia</option>
                    <option value="ME" {% if form.origin_country.value == 'ME' %}selected{% endif %}>Montenegro</option>
                    <option value="MA" {% if form.origin_country.value == 'MA' %}selected{% endif %}>Morocco</option>
                    <option value="MZ" {% if form.origin_country.value == 'MZ' %}selected{% endif %}>Mozambique</option>
                    <option value="MM" {% if form.origin_country.value == 'MM' %}selected{% endif %}>Myanmar</option>
                    <option value="NA" {% if form.origin_country.value == 'NA' %}selected{% endif %}>Namibia</option>
                    <option value="NR" {% if form.origin_country.value == 'NR' %}selected{% endif %}>Nauru</option>
                    <option value="NP" {% if form.origin_country.value == 'NP' %}selected{% endif %}>Nepal</option>
                    <option value="NL" {% if form.origin_country.value == 'NL' %}selected{% endif %}>Netherlands</option>
                    <option value="NZ" {% if form.origin_country.value == 'NZ' %}selected{% endif %}>New Zealand</option>
                    <option value="NI" {% if form.origin_country.value == 'NI' %}selected{% endif %}>Nicaragua</option>
                    <option value="NE" {% if form.origin_country.value == 'NE' %}selected{% endif %}>Niger</option>
                    <option value="NG" {% if form.origin_country.value == 'NG' %}selected{% endif %}>Nigeria</option>
                    <option value="MK" {% if form.origin_country.value == 'MK' %}selected{% endif %}>North Macedonia</option>
                    <option value="NO" {% if form.origin_country.value == 'NO' %}selected{% endif %}>Norway</option>
                    <option value="OM" {% if form.origin_country.value == 'OM' %}selected{% endif %}>Oman</option>
                    <option value="PK" {% if form.origin_country.value == 'PK' %}selected{% endif %}>Pakistan</option>
                    <option value="PW" {% if form.origin_country.value == 'PW' %}selected{% endif %}>Palau</option>
                    <option value="PS" {% if form.origin_country.value == 'PS' %}selected{% endif %}>Palestine</option>
                    <option value="PA" {% if form.origin_country.value == 'PA' %}selected{% endif %}>Panama</option>
                    <option value="PG" {% if form.origin_country.value == 'PG' %}selected{% endif %}>Papua New Guinea</option>
                    <option value="PY" {% if form.origin_country.value == 'PY' %}selected{% endif %}>Paraguay</option>
                    <option value="PE" {% if form.origin_country.value == 'PE' %}selected{% endif %}>Peru</option>
                    <option value="PH" {% if form.origin_country.value == 'PH' %}selected{% endif %}>Philippines</option>
                    <option value="PL" {% if form.origin_country.value == 'PL' %}selected{% endif %}>Poland</option>
                    <option value="PT" {% if form.origin_country.value == 'PT' %}selected{% endif %}>Portugal</option>
                    <option value="PR" {% if form.origin_country.value == 'PR' %}selected{% endif %}>Puerto Rico</option>
                    <option value="QA" {% if form.origin_country.value == 'QA' %}selected{% endif %}>Qatar</option>
                    <option value="RO" {% if form.origin_country.value == 'RO' %}selected{% endif %}>Romania</option>
                    <option value="RU" {% if form.origin_country.value == 'RU' %}selected{% endif %}>Russia</option>
                    <option value="RW" {% if form.origin_country.value == 'RW' %}selected{% endif %}>Rwanda</option>
                    <option value="KN" {% if form.origin_country.value == 'KN' %}selected{% endif %}>Saint Kitts and Nevis</option>
                    <option value="LC" {% if form.origin_country.value == 'LC' %}selected{% endif %}>Saint Lucia</option>
                    <option value="VC" {% if form.origin_country.value == 'VC' %}selected{% endif %}>Saint Vincent and the Grenadines</option>
                    <option value="WS" {% if form.origin_country.value == 'WS' %}selected{% endif %}>Samoa</option>
                    <option value="SM" {% if form.origin_country.value == 'SM' %}selected{% endif %}>San Marino</option>
                    <option value="ST" {% if form.origin_country.value == 'ST' %}selected{% endif %}>Sao Tome and Principe</option>
                    <option value="SA" {% if form.origin_country.value == 'SA' %}selected{% endif %}>Saudi Arabia</option>
                    <option value="SN" {% if form.origin_country.value == 'SN' %}selected{% endif %}>Senegal</option>
                    <option value="RS" {% if form.origin_country.value == 'RS' %}selected{% endif %}>Serbia</option>
                    <option value="SC" {% if form.origin_country.value == 'SC' %}selected{% endif %}>Seychelles</option>
                    <option value="SL" {% if form.origin_country.value == 'SL' %}selected{% endif %}>Sierra Leone</option>
                    <option value="SG" {% if form.origin_country.value == 'SG' %}selected{% endif %}>Singapore</option>
                    <option value="SK" {% if form.origin_country.value == 'SK' %}selected{% endif %}>Slovakia</option>
                    <option value="SI" {% if form.origin_country.value == 'SI' %}selected{% endif %}>Slovenia</option>
                    <option value="SB" {% if form.origin_country.value == 'SB' %}selected{% endif %}>Solomon Islands</option>
                    <option value="SO" {% if form.origin_country.value == 'SO' %}selected{% endif %}>Somalia</option>
                    <option value="ZA" {% if form.origin_country.value == 'ZA' %}selected{% endif %}>South Africa</option>
                    <option value="SS" {% if form.origin_country.value == 'SS' %}selected{% endif %}>South Sudan</option>
                    <option value="ES" {% if form.origin_country.value == 'ES' %}selected{% endif %}>Spain</option>
                    <option value="LK" {% if form.origin_country.value == 'LK' %}selected{% endif %}>Sri Lanka</option>
                    <option value="SD" {% if form.origin_country.value == 'SD' %}selected{% endif %}>Sudan</option>
                    <option value="SR" {% if form.origin_country.value == 'SR' %}selected{% endif %}>Suriname</option>
                    <option value="SE" {% if form.origin_country.value == 'SE' %}selected{% endif %}>Sweden</option>
                    <option value="CH" {% if form.origin_country.value == 'CH' %}selected{% endif %}>Switzerland</option>
                    <option value="SY" {% if form.origin_country.value == 'SY' %}selected{% endif %}>Syria</option>
                    <option value="TW" {% if form.origin_country.value == 'TW' %}selected{% endif %}>Taiwan</option>
                    <option value="TJ" {% if form.origin_country.value == 'TJ' %}selected{% endif %}>Tajikistan</option>
                    <option value="TZ" {% if form.origin_country.value == 'TZ' %}selected{% endif %}>Tanzania</option>
                    <option value="TH" {% if form.origin_country.value == 'TH' %}selected{% endif %}>Thailand</option>
                    <option value="TL" {% if form.origin_country.value == 'TL' %}selected{% endif %}>Timor-Leste</option>
                    <option value="TG" {% if form.origin_country.value == 'TG' %}selected{% endif %}>Togo</option>
                    <option value="TO" {% if form.origin_country.value == 'TO' %}selected{% endif %}>Tonga</option>
                    <option value="TT" {% if form.origin_country.value == 'TT' %}selected{% endif %}>Trinidad and Tobago</option>
                    <option value="TN" {% if form.origin_country.value == 'TN' %}selected{% endif %}>Tunisia</option>
                    <option value="TR" {% if form.origin_country.value == 'TR' %}selected{% endif %}>Turkey</option>
                    <option value="TM" {% if form.origin_country.value == 'TM' %}selected{% endif %}>Turkmenistan</option>
                    <option value="TV" {% if form.origin_country.value == 'TV' %}selected{% endif %}>Tuvalu</option>
                    <option value="UG" {% if form.origin_country.value == 'UG' %}selected{% endif %}>Uganda</option>
                    <option value="UA" {% if form.origin_country.value == 'UA' %}selected{% endif %}>Ukraine</option>
                    <option value="AE" {% if form.origin_country.value == 'AE' %}selected{% endif %}>United Arab Emirates</option>
                    <option value="GB" {% if form.origin_country.value == 'GB' %}selected{% endif %}>United Kingdom</option>
                    <option value="US" {% if form.origin_country.value == 'US' %}selected{% endif %}>United States</option>
                    <option value="UY" {% if form.origin_country.value == 'UY' %}selected{% endif %}>Uruguay</option>
                    <option value="UZ" {% if form.origin_country.value == 'UZ' %}selected{% endif %}>Uzbekistan</option>
                    <option value="VU" {% if form.origin_country.value == 'VU' %}selected{% endif %}>Vanuatu</option>
                    <option value="VE" {% if form.origin_country.value == 'VE' %}selected{% endif %}>Venezuela</option>
                    <option value="VN" {% if form.origin_country.value == 'VN' %}selected{% endif %}>Vietnam</option>
                    <option value="YE" {% if form.origin_country.value == 'YE' %}selected{% endif %}>Yemen</option>
                    <option value="ZM" {% if form.origin_country.value == 'ZM' %}selected{% endif %}>Zambia</option>
                    <option value="ZW" {% if form.origin_country.value == 'ZW' %}selected{% endif %}>Zimbabwe</option>            </select>

            <label class="margin-top-12" for="description">
                Description
                <span id="desc-word-count" class="word-counter">0/25 words</span>
            </label>
            <div class="desc-row">
                <textarea name="description" id="description" placeholder="Enter a brief description (max 25 words)">{{ form.description.value|default:'' }}</textarea>
                
                <div class="upload-area">
                    <span class="upload-label-text">
                        {% if form.instance.image %}Change Image{% else %}Upload meal here{% endif %}
                    </span>

                    <label for="photoUpload" class="file-icon-btn" title="Upload meal photo">
                        <span style="position:absolute; width:1px; height:1px; overflow:hidden; clip:rect(0,0,0,0);">Upload</span>
                    </label>
                    <input type="file" id="photoUpload" name="image" accept="image/*" onchange="previewFile(this)" style="opacity: 0;" {% if not form.instance.image %}required{% endif %}>
                    <div class="hint" id="fileMsg" style="color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.8);">
                        {% if form.instance.image %}
                            <span style="font-weight: 500;">✓ Current image saved</span>
                        {% else %}
                            Size (max 10MB)
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- INGREDIENTS SECTION -->
        <!-- Dynamically populated list of ingredients -->
        <div class="form-card">
            <h2>Ingredients</h2>
            <div id="ingredients-container"></div>
            <div style="display: flex; justify-content: flex-end; margin-top: 10px;">
                <button type="button" class="action-btn" onclick="addIngredientRow()">+</button>
            </div>
        </div>

        <!-- COOKING STEPS SECTION -->
        <!-- Dynamically populated list of cooking instructions -->
        <div class="form-card">
            <h2>Cooking Steps</h2>
            <div id="steps-container"></div>
             <div style="display: flex; justify-content: flex-end; margin-top: 10px;">
                <button type="button" class="action-btn" onclick="addStepRow()">+</button>
            </div>
        </div>

        
        <div class="form-card"> 
            <div class="grid-row">
                <div>
                    <label for="healthCondition">Health Condition</label>
                    <select name="health_condition" id="healthCondition" >
                      <option value="">Select Condition</option>
                      <option value="None" {% if form.health_condition.value == 'None' %}selected{% endif %}>None</option>

                      <option value="Diabetes" {% if form.health_condition.value == 'Diabetes' %}selected{% endif %}>Diabetes (Low Sugar/Carb)</option>
                      <option value="Hypertension" {% if form.health_condition.value == 'Hypertension' %}selected{% endif %}>Hypertension (Low Sodium)</option>
                      <option value="Heart Disease" {% if form.health_condition.value == 'Heart Disease' %}selected{% endif %}>Heart Disease (Low Cholesterol)</option>
                      <option value="Obesity" {% if form.health_condition.value == 'Obesity' %}selected{% endif %}>Obesity / Weight Loss</option>

                      <option value="Celiac" {% if form.health_condition.value == 'Celiac' %}selected{% endif %}>Celiac Disease (Strict Gluten-Free)</option>
                      <option value="GERD" {% if form.health_condition.value == 'GERD' %}selected{% endif %}>GERD / Acid Reflux</option>
                      <option value="IBS" {% if form.health_condition.value == 'IBS' %}selected{% endif %}>IBS (Low FODMAP)</option>

                      <option value="Kidney Disease" {% if form.health_condition.value == 'Kidney Disease' %}selected{% endif %}>Kidney Disease</option>
                      <option value="Gout" {% if form.health_condition.value == 'Gout' %}selected{% endif %}>Gout (Low Purine)</option>
                      <option value="Anemia" {% if form.health_condition.value == 'Anemia' %}selected{% endif %}>Anemia (High Iron)</option>
                  </select>
                </div>
                <div>
                    <label class="h2" for="dietary">Dietary</label>
                    <select name="dietary" id="dietary" >
                      <option value="">Select Preference</option>
                      
                      <option value="None" {% if form.dietary.value == 'None' %}selected{% endif %}>None</option>

                      <option value="Vegetarian" {% if form.dietary.value == 'Vegetarian' %}selected{% endif %}>Vegetarian (No Meat)</option>
                      <option value="Vegan" {% if form.dietary.value == 'Vegan' %}selected{% endif %}>Vegan (No Animal Products)</option>
                      <option value="Pescatarian" {% if form.dietary.value == 'Pescatarian' %}selected{% endif %}>Pescatarian (Fish Allowed)</option>
                      <option value="Keto" {% if form.dietary.value == 'Keto' %}selected{% endif %}>Keto / Low Carb</option>

                      <option value="Halal" {% if form.dietary.value == 'Halal' %}selected{% endif %}>Halal</option>
                      <option value="Kosher" {% if form.dietary.value == 'Kosher' %}selected{% endif %}>Kosher</option>

                      <option value="Gluten-Free" {% if form.dietary.value == 'Gluten-Free' %}selected{% endif %}>Gluten-Free</option>
                      <option value="Dairy-Free" {% if form.dietary.value == 'Dairy-Free' %}selected{% endif %}>Dairy-Free</option>
                      <option value="Nut-Free" {% if form.dietary.value == 'Nut-Free' %}selected{% endif %}>Nut-Free</option>
                      <option value="Shellfish-Free" {% if form.dietary.value == 'Shellfish-Free' %}selected{% endif %}>Shellfish-Free</option>
                  </select>
                </div>
            </div>

            <label class="margin-top-12" for="mealType">Meal Type</label>
            <select name="meal_type" id="mealType">
                <option value="Family" {% if form.meal_type.value == 'Family' %}selected{% endif %}>Family</option>
                <option value="Individual" {% if form.meal_type.value == 'Individual' %}selected{% endif %}>Individual</option>
                
            </select>

            <label class="margin-top-12" for="mealTime">Meal Time</label>
            <select name="meal_time" id="mealTime">
                <option value="Breakfast" {% if form.meal_time.value == 'Breakfast' %}selected{% endif %}>Breakfast</option>
                <option value="Lunch" {% if form.meal_time.value == 'Lunch' %}selected{% endif %}>Lunch</option>
                <option value="Dinner" {% if form.meal_time.value == 'Dinner' %}selected{% endif %}>Dinner</option>
            </select>

            <div class="form-group margin-top-12">
              <label for="cooking_time">Cooking Time (minutes)</label>
              <input type="number" name="cooking_time" id="cooking_time" class="form-control" 
                     value="{{ form.cooking_time.value|default:30 }}" required>
              
              {% if form.cooking_time.errors %}
                  <div class="text-danger">{{ form.cooking_time.errors }}</div>
              {% endif %}
            </div>

            <label class="margin-top-12" for="amount">Amount</label>
            <div class="amount-container">
                <input type="number" name="budget" id="amount" class="amount-input" placeholder="Enter budget" value="{{ form.budget.value|default:'' }}">
                <div class="currency-select-wrapper">
                    <select name="currency" id="currency" title="Select currency">
                            <option title="Central African CFA franc" value="XAF" {% if form.currency.value == 'XAF' %}selected{% endif %}>XAF (FCFA)</option>
                            <option value="XOF" {% if form.currency.value == 'XOF' %}selected{% endif %}>XOF (CFA)</option>
                            <option value="NGN" {% if form.currency.value == 'NGN' %}selected{% endif %}>NGN (₦)</option>
                            <option value="GHS" {% if form.currency.value == 'GHS' %}selected{% endif %}>GHS (GH₵)</option>
                            <option value="CDF" {% if form.currency.value == 'CDF' %}selected{% endif %}>CDF (FC)</option>
                            <option value="KES" {% if form.currency.value == 'KES' %}selected{% endif %}>KES (KSh)</option>
                            <option value="ZAR" {% if form.currency.value == 'ZAR' %}selected{% endif %}>ZAR (R)</option>
                            <option value="EGP" {% if form.currency.value == 'EGP' %}selected{% endif %}>EGP (E£)</option>
                            <option value="MAD" {% if form.currency.value == 'MAD' %}selected{% endif %}>MAD (DH)</option>
                            <option value="RWF" {% if form.currency.value == 'RWF' %}selected{% endif %}>RWF (FRw)</option>
                        
                            <option value="USD" {% if form.currency.value == 'USD' %}selected{% endif %}>USD ($)</option>
                            <option value="EUR" {% if form.currency.value == 'EUR' %}selected{% endif %}>EUR (€)</option>
                            <option value="GBP" {% if form.currency.value == 'GBP' %}selected{% endif %}>GBP (£)</option>
                            <option value="CAD" {% if form.currency.value == 'CAD' %}selected{% endif %}>CAD (C$)</option>
                            <option value="AUD" {% if form.currency.value == 'AUD' %}selected{% endif %}>AUD (A$)</option>
                            <option value="CNY" {% if form.currency.value == 'CNY' %}selected{% endif %}>CNY (¥)</option>
                            <option value="INR" {% if form.currency.value == 'INR' %}selected{% endif %}>INR (₹)</option>
                            <option value="JPY" {% if form.currency.value == 'JPY' %}selected{% endif %}>JPY (¥)</option>
                            <option value="AED" {% if form.currency.value == 'AED' %}selected{% endif %}>AED (DH)</option>
                            <option value="SAR" {% if form.currency.value == 'SAR' %}selected{% endif %}>SAR (SR)</option>
                    </select>
                </div>
            </div>

            <label class="margin-top-12" for="id_video_url">
                Video Tutorial 
                <span style="font-weight: 400; font-size: 12px; color: var(--muted);">(Optional)</span>
            </label>
            
            <div class="video-input-wrapper">
                <svg class="yt-svg-icon" viewBox="0 0 576 512" xmlns="http://www.w3.org/2000/svg">
                    <path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/>
                </svg>
                
                <input type="url" 
                       name="video_url" 
                       id="id_video_url" 
                       class="video-input"
                       placeholder="https://www.youtube.com/watch?v=..." 
                       value="{{ form.video_url.value|default:'' }}">
            </div>
            
            {% if form.video_url.errors %}
                <div style="color: #d32f2f; font-size: 12px; margin-top: 4px; font-weight: 500;">
                     {{ form.video_url.errors.0 }}
                </div>
            {% endif %}
        </div>

        <!-- SUBMIT BUTTON -->
        <!-- Changes text based on create vs update -->
        <button type="submit" class="submit-btn">
            {% if form.instance.pk %}Update Recipe{% else %}Submit Recipe{% endif %}
        </button>

    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    /* INITIALIZATION ON PAGE LOAD */
    /* Set up event listeners and load persisted data */
    document.addEventListener('DOMContentLoaded', () => {
        
        /* 1. Load saved ingredients and instructions from hidden fields */
        loadIngredients();
        loadInstructions();

        /* 2. Initialize word counter for description field */
        const descField = document.getElementById('description');
        const counterDisplay = document.getElementById('desc-word-count');
        const MAX_WORDS = 25;

        if (descField && counterDisplay) {
            /* Update word count display and enforce maximum limit */
            function updateWordCount() {
                let val = descField.value;
                let words = val.trim().split(/\s+/);
                if (val.trim() === '') words = [];

                if (words.length > MAX_WORDS) {
                    const croppedWords = words.slice(0, MAX_WORDS);
                    descField.value = croppedWords.join(" ");
                    words = croppedWords;
                    counterDisplay.classList.add('limit-reached');
                } else {
                    counterDisplay.classList.remove('limit-reached');
                }
                counterDisplay.innerText = `${words.length}/${MAX_WORDS} words`;
            }
            descField.addEventListener('input', updateWordCount);
            updateWordCount();
        }

        /* 3. Initialize custom dropdown styling for select elements */
        initCustomSelects();
    });

    /* HELPER FUNCTIONS */
    
    /* Load ingredients from hidden JSON field and populate form rows */
    function loadIngredients() {
        const input = document.getElementById('id_ingredients');
        const container = document.getElementById('ingredients-container');

        // 1. Clear the container to prevent duplicates
        container.innerHTML = ''; 

        let data = [];
        try {
            if (input.value) {
                let parsed = JSON.parse(input.value);
                if (typeof parsed === 'string') parsed = JSON.parse(parsed);
                data = parsed;
            }
        } catch (e) { console.error("Ing parse error", e); }

        if (Array.isArray(data) && data.length > 0) {
            data.forEach(item => addIngredientRow(item.name, item.qty));
        } else {
            addIngredientRow(); // Add one blank row for new forms
        }
    }

    /* Load instructions from hidden JSON field and populate form rows */
    function loadInstructions() {
        const input = document.getElementById('id_instructions');
        const container = document.getElementById('steps-container');

        //  Clear the container to prevent duplicates
        container.innerHTML = '';

        let data = [];
        try {
            if (input.value) {
                let parsed = JSON.parse(input.value);
                if (typeof parsed === 'string') parsed = JSON.parse(parsed);
                data = parsed;
            }
        } catch (e) { console.error("Step parse error", e); }

        if (Array.isArray(data) && data.length > 0) {
            data.forEach(step => addStepRow(step));
        } else {
            addStepRow(); // Add one blank row for new forms
        }
    }

    /* DYNAMIC ROW MANAGEMENT */
    /* Create new ingredient input row */
    const ingContainer = document.getElementById('ingredients-container');
    function addIngredientRow(name='', qty='') {
        const div = document.createElement('div');
        div.className = 'ingredient-row';
        div.innerHTML = `
            <input type="text" class="ing-name" placeholder="Ingredient name" value="${name}" required>
            <input type="text" class="ing-qty qty" placeholder="Quantity" value="${qty}" required>
            <button type="button" class="action-btn" onclick="this.parentElement.remove()">-</button>
        `;
        ingContainer.appendChild(div);
    }

    /* Create new cooking step input row */
    const stepContainer = document.getElementById('steps-container');
    function addStepRow(text='') {
        const div = document.createElement('div');
        div.className = 'step-row';
        // Handle quotes safely
        const safeText = text.replace(/"/g, '&quot;'); 
        div.innerHTML = `
            <input type="text" class="step-text" placeholder="Write instruction here" value="${safeText}" required>
            <button type="button" class="action-btn" onclick="this.parentElement.remove()">-</button>
        `;
        stepContainer.appendChild(div);
    }

    /* FORM SUBMISSION HANDLER */
    /* Prepare data and submit form */
    document.getElementById('recipeForm').addEventListener('submit', function(e) {
        // Prepare Ingredients JSON
        const ings = [];
        document.querySelectorAll('.ingredient-row').forEach(row => {
            const name = row.querySelector('.ing-name').value;
            const qty = row.querySelector('.ing-qty').value;
            if(name) ings.push({name, qty});
        });
        document.getElementById('id_ingredients').value = JSON.stringify(ings);

        // Prepare Instructions JSON
        const steps = [];
        document.querySelectorAll('.step-text').forEach(inp => {
            if(inp.value) steps.push(inp.value);
        });
        document.getElementById('id_instructions').value = JSON.stringify(steps);
    });

    // FILE PREVIEW
    function previewFile(input) {
        const msg = document.getElementById('fileMsg');
        if(input.files && input.files[0]) msg.textContent = input.files[0].name;
    }

    // CUSTOM SELECTS
    function initCustomSelects() {
        const selects = document.querySelectorAll('select');
        selects.forEach(sel => {
            if (sel.classList.contains('custom-hidden')) return;

            sel.classList.add('custom-hidden');
            const wrapper = document.createElement('div');
            wrapper.className = 'custom-select';

            const trigger = document.createElement('div');
            trigger.className = 'custom-select-trigger';
            const initialText = sel.options[sel.selectedIndex] ? sel.options[sel.selectedIndex].text : 'Select';
            trigger.innerHTML = `<span>${initialText}</span><span>&#x25BE;</span>`;

            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'custom-options';

            Array.from(sel.options).forEach((opt) => {
                const item = document.createElement('div');
                item.className = 'custom-option';
                item.textContent = opt.text;
                item.onclick = () => {
                    sel.value = opt.value;
                    trigger.firstElementChild.textContent = opt.text;
                    wrapper.classList.remove('open');
                    sel.dispatchEvent(new Event('change')); 
                };
                optionsContainer.appendChild(item);
            });

            trigger.onclick = () => {
                document.querySelectorAll('.custom-select').forEach(s => s !== wrapper && s.classList.remove('open'));
                wrapper.classList.toggle('open');
            };

            wrapper.appendChild(trigger);
            wrapper.appendChild(optionsContainer);
            sel.parentNode.insertBefore(wrapper, sel.nextSibling);

            sel.addEventListener('change', () => {
                if(sel.options[sel.selectedIndex]) {
                    trigger.firstElementChild.textContent = sel.options[sel.selectedIndex].text;
                }
            });
        });
    }

    window.onclick = (e) => {
        if (!e.target.closest('.custom-select')) {
            document.querySelectorAll('.custom-select').forEach(s => s.classList.remove('open'));
        }
    };
</script>
{% endblock %}